{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ product.name }} | Product Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'store/css/product.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <!-- Product Image -->
    <div class="col-md-6 mb-4">
      {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid product-image" id="product-image">
      {% else %}
        <img src="{% static 'store/images/default_product.png' %}" alt="No image available" class="img-fluid product-image" id="product-image">
      {% endif %}
    </div>

    <!-- Product Info -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ product.name }}</h2>
      <p class="text-muted">{{ product.category.name }}</p>
      <p class="fs-4 fw-semibold text-success">₹{{ product.price|floatformat:2 }}</p>

      <!-- Product Rating -->
      <p class="product-rating">
        <strong>Rating:</strong>
        {% for i in "12345"|slice:":product.avg_rating"|make_list %}
          <i class="bi bi-star-fill text-warning"></i>
        {% endfor %}
        <span class="ms-1">({{ product.avg_rating }} / 5)</span>
      </p>

      <p>{{ product.description|truncatewords:30 }} <a href="#" class="btn btn-link p-0">Read More</a></p>

      <!-- Cart and Buy -->
      <form action="{% url 'add_to_cart' product.id %}" method="POST" class="d-inline-block me-2">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-cart-plus"></i> Add to Cart
        </button>
      </form>
      <a href="{% url 'buy_now' product.id %}" class="btn btn-success btn-sm">⚡ Buy Now</a>

      <!-- Wishlist -->
      <div class="mt-3">
        {% if user.is_authenticated %}
          {% if in_wishlist %}
            <a href="{% url 'remove_from_wishlist' product.id %}" class="btn btn-danger btn-sm">
              <i class="bi bi-heart-fill"></i> Remove from Wishlist
            </a>
          {% else %}
            <a href="{% url 'add_to_wishlist' product.id %}" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-heart"></i> Add to Wishlist
            </a>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-heart"></i> Login to use Wishlist
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <hr class="my-5">

  <!-- Back to Products -->
  <div class="text-center mb-4">
    <a href="{% url 'home' %}" class="btn btn-outline-dark">← Back to Products</a>
  </div>

  <!-- Reviews Section -->
  <h4 class="mb-3">Customer Reviews</h4>

  <!-- Filter by Rating -->
  <div class="mb-4">
    <strong>Filter by Rating:</strong>
    {% for star in "54321"|make_list %}
      <a href="?rating={{ star }}" class="btn btn-outline-secondary btn-sm {% if selected_rating|stringformat:"s" == star %}active{% endif %}">
        {{ star }}★
      </a>
    {% endfor %}
    <a href="{% url 'product_detail' product.slug %}" class="btn btn-outline-dark btn-sm {% if not selected_rating %}active{% endif %}">All</a>
  </div>

  <!-- Review List -->
  {% if reviews %}
    {% for review in reviews %}
      <div class="review-box p-3 mb-3 border rounded bg-light">
        <strong>{{ review.user.username }}</strong>
        <span class="text-warning ms-2">
          {% for i in "12345"|slice:":review.rating"|make_list %}★{% endfor %}
        </span>
        <p class="mb-1">{{ review.comment }}</p>
        <small class="text-muted">{{ review.created_at|date:"F j, Y" }}</small>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No reviews found for this rating.</p>
  {% endif %}

  <!-- Review Form -->
  {% if user.is_authenticated %}
    <hr class="mt-5">
    <h4>Write a Review</h4>
    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        {{ review_form.rating.label_tag }} {{ review_form.rating }}
      </div>
      <div class="mb-3">
        {{ review_form.comment.label_tag }} {{ review_form.comment }}
      </div>
      <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
  {% else %}
    <p><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to write a review.</p>
  {% endif %}
</div>
{% endblock %}
