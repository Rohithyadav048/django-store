{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<div class="container text-center razorpay-container mt-5">
  <h2 class="mb-4">Complete Payment</h2>
  <p class="lead">Click the button below to securely pay for your order.</p>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="my-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Opening Razorpay checkout...</p>
  </div>

  <!-- Pay Button -->
  <button id="rzp-button"
          class="btn btn-primary btn-lg mt-3"
          data-key="{{ razorpay_key_id }}"
          data-amount="{{ razorpay_amount }}"
          data-order-id="{{ razorpay_order_id }}"
          data-name="{{ user.get_full_name|default:user.username }}"
          data-email="{{ user.email }}">
      Pay Now
  </button>

  <p class="mt-4 small text-muted">
    You will be redirected to Razorpayâ€™s secure payment gateway.<br>
    If payment fails, please contact <a href="mailto:support@quickcart.com">support@quickcart.com</a>.
  </p>
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const options = {
    key: "{{ razorpay_key_id }}",
    amount: "{{ razorpay_amount }}",
    currency: "INR",
    name: "QuickCart",
    description: "Order Payment",
    order_id: "{{ razorpay_order_id }}",
    handler: function (response) {
      // Show loading spinner while verifying
      document.querySelector('.razorpay-container').innerHTML = `
        <div class="my-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Verifying Payment...</span>
          </div>
          <p class="mt-3">Verifying your payment, please wait...</p>
        </div>
      `;

      fetch("{% url 'payment_handler' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_order_id: response.razorpay_order_id,
          razorpay_signature: response.razorpay_signature
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          window.location.href = "{% url 'payment_success' %}";
        } else {
          document.querySelector('.razorpay-container').innerHTML = `
            <h3 class="text-danger">Payment Verification Failed</h3>
            <p>There was an issue verifying your payment. Please try again or contact support.</p>
            <a href="{% url 'home' %}" class="btn btn-outline-primary mt-3">Go to Home</a>
          `;
        }
      })
      .catch(error => {
        document.querySelector('.razorpay-container').innerHTML = `
          <h3 class="text-danger">Unexpected Error</h3>
          <p>Something went wrong while verifying your payment. Please try again.</p>
          <a href="{% url 'home' %}" class="btn btn-outline-dark mt-3">Back to Home</a>
        `;
      });
    },
    prefill: {
      name: "{{ user.get_full_name|default:user.username }}",
      email: "{{ user.email }}"
    },
    theme: {
      color: "#0d6efd"
    }
  };

  const rzp = new Razorpay(options);
  document.getElementById("rzp-button").onclick = function (e) {
    document.getElementById("loading-spinner").style.display = 'block';
    rzp.open();
    e.preventDefault();
  };
</script>
{% endblock %}
